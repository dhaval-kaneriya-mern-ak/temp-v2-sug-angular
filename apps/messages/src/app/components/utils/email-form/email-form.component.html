<div class="email-form-section">
  <h3 class="d-flex mb-4">
    {{ title }}
    <sug-ui-tooltip
      [text]="'Click to learn more about composing messages.'"
      [position]="'bottom'"
      [tooltipClass]="'custom-tooltip'"
      [tooltipOptions]="{
        showDelay: 200,
        autoHide: true,
        tooltipEvent: 'hover'
      }"
    >
      <p-button variant="text" size="small" (click)="onOpenHelpDialog()"
        ><i class="fa-solid fa-circle-question info-icon fs-6 ms-2"></i>
      </p-button>
    </sug-ui-tooltip>
  </h3>

  <form [formGroup]="emailForm">
    <!-- Sign Up Links -->
    <div class="form-wrapper">
      <label for="signup-links">Sign Up Link(s)</label>
      @if (showInlineSignupDropdown) {
      <sug-ui-multi-select-dropdown
        [options]="signUpOptions"
        [optionGroupLabel]="'label'"
        [optionGroupChildren]="'items'"
        [group]="true"
        [placeholder]="'Select Sign Up(s)'"
        panelStyleClass="custom-dropdown"
        appendTo="parent"
        (valueChanged)="onSignUpSelectionChange($event)"
        [formControl]="dropdownControl"
      >
        <ng-template #group let-group>
          <div class="flex items-center">
            <span> {{ group.label }}</span>
          </div>
        </ng-template>
      </sug-ui-multi-select-dropdown>
      } @else if (!hasSignupSelection) {
      <sug-ui-button
        type="button"
        class="add-link-btn"
        icon=""
        label="Select Sign Ups"
        (buttonClick)="onOpenSignUpsDialog()"
      >
      </sug-ui-button>
      } @else if (hasSignupSelection) {
      <div class="signup-chips-container">
        <div class="chips-container">
          @for (item of selectedSignups; track item.signupid || $index; let i =
          $index) {
          <span [ngClass]="{ '': selectedSignups.length > 1 && i >= 1 }">
            <p-chip
              class="gap-2"
              [label]="getSignupTitle(item)"
              [removable]="true"
              (onRemove)="removeSignup(i)"
            />
          </span>
          } @for (item of selectedTabGroups; track item.id || $index; let i =
          $index) {
          <span [ngClass]="{ '': selectedSignups.length > 0 || i >= 1 }">
            <p-chip
              class="gap-2"
              [label]="item.name"
              [removable]="true"
              (onRemove)="removeTabGroup(i)"
            />
          </span>
          } @for (item of selectedPortalPages; track item.id || $index; let i =
          $index) {
          <span [ngClass]="{ '': selectedPortalPages.length > 0 || i >= 1 }">
            <p-chip
              class="gap-2"
              [label]="item.title"
              [removable]="true"
              (onRemove)="removePortalPage(i)"
            />
          </span>
          } @if (isSignUpIndexPageSelected) {
          <span>
            <p-chip
              class="gap-2"
              label="Sign Up Index Page"
              [removable]="true"
              (onRemove)="removeSignUpIndexPage()"
            />
          </span>
          }
        </div>
        <button
          type="button"
          class="edit-signup-btn"
          (click)="onOpenSignUpsDialog()"
          aria-label="Edit selected sign ups"
        >
          <i class="fa-solid fa-pencil"></i>
        </button>
      </div>
      }
    </div>

    <!-- From Name -->
    <div class="form-wrapper">
      <label for="from-name">From</label>
      <input type="text" formControlName="fromName" />
      @if (emailForm.get('fromName')?.invalid &&
      emailForm.get('fromName')?.touched) {
      <small class="error-message">Name is required</small>
      }
    </div>

    <!-- Reply To -->
    @if (!isBasicUser) {
    <div class="form-wrapper">
      <label for="reply-to">Reply To</label>
      <sug-ui-multi-select-dropdown
        id="reply-to"
        [options]="subAdminsData"
        formControlName="replyTo"
      >
      </sug-ui-multi-select-dropdown>
    </div>
    }

    <!-- To (People Selection) -->
    <div class="form-wrapper">
      <label for="to-people">To</label>
      @if (!hasPeopleSelection) {
      <sug-ui-button
        type="button"
        class="add-link-btn"
        icon=""
        label="Select People"
        [disabled]="!hasSignupSelection"
        (buttonClick)="onOpenPeopleDialog()"
      >
      </sug-ui-button>
      } @if (hasPeopleSelection && selectedDateSlots.length === 0 &&
      selectedMemberGroups.length === 0) {
      <div class="recipient-info-container signup-chips-container">
        <div class="chips-container">
          @for (item of selectedGroups; track item.value || $index; let i =
          $index) {
          <span>
            <p-chip
              class="gap-2"
              [label]="item.label"
              [removable]="true"
              (onRemove)="removeGroup(i)"
            />
          </span>
          }
        </div>
        <div class="recipient-text">
          <button
            type="button"
            class="edit-icon-btn"
            (click)="onOpenPeopleDialog()"
            aria-label="Edit recipient selection"
          >
            <i class="fa-solid fa-pencil"></i>
          </button>
        </div>
        <button
          type="button"
          class="recipient-details-btn"
          (click)="onShowRecipientDetails()"
        >
          {{ recipientCount }} Recipient Details
        </button>
      </div>
      } @if (selectedDateSlots.length > 0) {
      <div class="recipient-info-container">
        <div class="recipient-text">
          <span class="recipient-label">Selected Dates/Slots</span>
        </div>
        <div class="recipient-text">
          <button
            type="button"
            class="edit-icon-btn"
            (click)="onEditSelectedSlots()"
            aria-label="Edit selected slots"
          >
            <i class="fa-solid fa-pencil"></i>
          </button>
        </div>
        <button
          type="button"
          class="recipient-details-btn"
          (click)="onShowRecipientDetails()"
        >
          {{ recipientCount }} Recipient Details
        </button>
      </div>
      } @if (selectedMemberGroups.length > 0) {
      <div class="recipient-info-container">
        <div class="recipient-text">
          <span class="recipient-label">Custom Selection</span>
        </div>
        <div class="recipient-text">
          <button
            type="button"
            class="edit-icon-btn"
            (click)="onEditSelectedMemberGroups()"
            aria-label="Edit selected member groups"
          >
            <i class="fa-solid fa-pencil"></i>
          </button>
        </div>
        <button
          type="button"
          class="recipient-details-btn"
          (click)="onShowRecipientDetails()"
        >
          {{ recipientCount }} Recipient Details
        </button>
      </div>
      }
    </div>

    <!-- Subject -->
    <div class="form-wrapper">
      <label for="from-subject">Subject</label>
      <input
        type="text"
        placeholder="Enter email subject"
        id="from-subject"
        formControlName="subject"
      />
      @if (emailForm.get('subject')?.invalid &&
      emailForm.get('subject')?.touched) {
      <small class="error-message">Subject is required</small>
      }
    </div>

    <!-- Message -->
    <div class="form-wrapper">
      <label for="from-message">Message</label>
      <textarea
        id="from-message"
        placeholder="Type your message here..."
        formControlName="message"
      >
      </textarea>
      @if (emailForm.get('message')?.invalid &&
      emailForm.get('message')?.touched) {
      <small class="error-message">Message is required</small>
      }
    </div>

    <!-- Attachments -->
    @if (!isBasicUser) {
    <div class="form-wrapper">
      <label for="attachments">Attachments</label>
      <sug-ui-button
        type="button"
        class="add-link-btn"
        icon="fa-solid fa-paperclip"
        label="Add Attachments"
        [disabled]="!canAddMoreAttachments()"
        (buttonClick)="onOpenSelectFileDialog()"
      >
      </sug-ui-button>
    </div>
    }

    <div class="form-wrapper">
      <label for="attachments-list"></label>
      <!-- Storage Progress Bar -->
      @if (selectedAttachments.length > 0) {
      <div class="attachments-container">
        <div class="storage-header">
          <h3>Attachments</h3>
        </div>

        <!-- Attachments List -->
        <div class="attachments-list">
          @for (file of selectedAttachments; track file.id || $index; let i =
          $index) {
          <div class="attachment-item">
            <!-- File Icon and Info -->
            <div class="attachment-content">
              <div class="file-icon-wrapper">
                <i
                  [class]="
                    'fa-solid ' +
                    getFileTypeIcon(file.title || file.filename || '')
                  "
                ></i>
              </div>
              <div class="file-details">
                <div class="file-header">
                  <span
                    class="file-name"
                    [title]="file.title || file.filename"
                    >{{ file.title || file.filename }}</span
                  >
                  <span class="file-size">{{
                    getFormattedFileSize((file.filesizekb || 0) * 1024)
                  }}</span>
                </div>
              </div>
            </div>

            <!-- Download Button -->
            <button
              type="button"
              class="download-attachment-btn ml-1"
              (click)="downloadFile(file)"
              aria-label="Download attachment"
              title="Download attachment"
            >
              <i class="fa-solid fa-download"></i>
            </button>

            <!-- Remove Button -->
            <button
              type="button"
              class="remove-attachment-btn ml-1"
              (click)="removeAttachment(i)"
              aria-label="Remove attachment"
              title="Remove attachment"
            >
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          }
        </div>

        <div class="storage-info">
          <div class="storage-header">
            <span class="storage-size"
              >{{ getTotalAttachmentSizeFormatted() }} /
              {{ getMaxAttachmentSizeFormatted() }}</span
            >
          </div>
        </div>
      </div>
      }
    </div>
    <!-- Captcha -->
    <div class="form-wrapper">
      <label for="captcha"></label>
      <ngx-recaptcha2
        #captchaElem
        [siteKey]="siteKey"
        (reset)="handleReset()"
        (expire)="handleExpire()"
        (success)="handleSuccess($event)"
        [useGlobalDomain]="false"
        formControlName="token"
      >
      </ngx-recaptcha2>
    </div>

    <!-- Action Buttons -->
    <div class="btn-wrapper">
      <!-- Both forms: Button is disabled when form is invalid for consistent behavior -->
      <sug-ui-button
        severity="success"
        [outlined]="false"
        class="send-btn"
        icon=""
        label="Preview & Send"
        [disabled]="emailForm.invalid || recipientCount === 0"
        (buttonClick)="onPreviewAndSend()"
      >
      </sug-ui-button>
      <sug-ui-button
        severity="secondary"
        class="draft-btn"
        icon=""
        label="Save Draft"
        [disabled]="emailForm.invalid"
        (buttonClick)="onSaveDraft()"
      >
      </sug-ui-button>
    </div>
  </form>
</div>
